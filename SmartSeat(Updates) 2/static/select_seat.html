<!DOCTYPE html>
<html lang="en">
<head>
  <script src="firebase.js"></script>
  <meta charset="UTF-8">
  <title>Room 101</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      width: 500px;
      text-align: center;
    }
    h1 {
      color: #2f88c5;
      font-size: 36px;
      margin-bottom: 5px;
    }
    h2 {
      color: #666;
      font-size: 18px;
      margin: 0 0 20px;
    }
    .seat {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.1s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .seat:hover {
      transform: scale(1.05);
    }
    #seatContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .legend {
      font-size: 14px;
      margin-top: 15px;
    }
    .legend span {
      display: inline-block;
      width: 15px;
      height: 15px;
      border: 1px solid #333;
      border-radius: 3px;
      margin-right: 5px;
      vertical-align: middle;
    }
    #selectedSeats {
      color: #2f88c5;
      font-weight: bold;
      margin-top: 10px;
      font-size: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.2s;
      margin-top: 12px;
    }
    .reserve {
      background: #2f88c5;
      color: white;
    }
    .reserve:hover {
      background: #1a6fb3;
    }
    .back {
      background: #333;
      color: white;
    }
    .back:hover {
      background: #111;
    }

    /* Wheelchair-only seats */
    .wheelchair[data-status="available"] {
      background: #f1c40f;
    }
    .wheelchair[data-status="selected"] {
      background: #2f88c5;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Room 101</h1>
  <h2>Front</h2>
  <div id="seatContainer"></div>

  <div class="legend">
    <span style="background:#2ecc71;"></span> Available
    <span style="margin-left:15px;background:#2f88c5;"></span> Your Selection
    <span style="margin-left:15px;background:#e74c3c;"></span> Occupied
    <span style="margin-left:15px;background:#f1c40f;"></span> Wheelchair Only
  </div>

  <div id="selectedSeats">You selected: None</div>
  <button class="reserve">Reserve Seat</button>
  <button class="back" onclick="window.location='dashboard.html'">Back</button>
</div>

<script>
  // Read building code from query string (?building=A)
  const params = new URLSearchParams(location.search);
  const buildingCode = params.get("building") || "A";
  const buildingName = "Building " + buildingCode;

  const seatContainer = document.getElementById("seatContainer");
  const selectedSeats = document.getElementById("selectedSeats");

  // Wheelchair-only seats
  const wheelchairSeats = ["E1", "E7", "F1"];
  const shownAlert = new Set();

  // ----- Seat grid creation -----
  function createSeats(occupiedSeats = []) {
    const rows = ["A", "B", "C", "D", "E", "F", "G"];
    const cols = 7;

    // Clear previous seat elements before re-rendering
    seatContainer.innerHTML = "";

    for (let r of rows) {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "center";
      row.style.gap = "10px";

      for (let c = 1; c <= cols; c++) {
        const seatId = r + c;
        const s = document.createElement("div");
        s.className = "seat";
        s.textContent = seatId;

        // Wheelchair-only seats
        if (wheelchairSeats.includes(seatId)) {
          s.dataset.type = "wheelchair";
          s.dataset.status = "available";
          s.style.background = "#f1c40f";

          s.onclick = () => {
            if (!shownAlert.has(seatId)) {
              alert("This seat is reserved for wheelchair users.");
              shownAlert.add(seatId);
            }
            toggleSeat(s);
          };

        } else {
          // Seats that have already been reserved in Firestore
          if (occupiedSeats.includes(seatId)) {
            s.dataset.status = "occupied";
            s.style.background = "#e74c3c";
          } else {
            s.dataset.status = "available";
            s.style.background = "#2ecc71";
          }

          s.onclick = () => {
            if (s.dataset.status === "occupied") return;
            toggleSeat(s);
          };
        }

        row.appendChild(s);
      }
      seatContainer.appendChild(row);
    }
  }

  // ----- Toggle seat selection -----
  function toggleSeat(seatElement) {
    if (seatElement.dataset.status === "available") {
      seatElement.dataset.status = "selected";
      seatElement.style.background = "#2f88c5";
    } else if (seatElement.dataset.status === "selected") {
      seatElement.dataset.status = "available";

      if (seatElement.dataset.type === "wheelchair") {
        seatElement.style.background = "#f1c40f";
      } else {
        seatElement.style.background = "#2ecc71";
      }
    }
    updateSelectionText();
  }

  // ----- Update selection text at the bottom -----
  function updateSelectionText() {
    const selected = [...document.querySelectorAll('.seat[data-status="selected"]')]
      .map(s => s.textContent);

    selectedSeats.textContent =
      selected.length ? `You selected: ${selected.join(", ")}` : "You selected: None";
  }

  // ----- Load reserved seats from Firestore and render grid -----
  async function loadReservedSeats() {
    try {
      const snapshot = await db
        .collection("reservations")
        .where("building", "==", buildingName)
        .where("room", "==", "Room 101")
        .get();

      const occupied = [];

      snapshot.forEach(doc => {
        const data = doc.data();
        // Support both "seats: [array]" and "seat: 'A1, A2'" formats
        let seatList = [];
        if (Array.isArray(data.seats)) {
          seatList = data.seats;
        } else if (typeof data.seat === "string") {
          seatList = data.seat.split(",").map(s => s.trim());
        }
        occupied.push(...seatList);
      });

      createSeats(occupied);
    } catch (err) {
      console.error("Failed to load reserved seats:", err);
      createSeats([]); // Fallback to all available if error occurs
    }
  }

  // Initial render
  loadReservedSeats();

  // ----- Reserve button handler -----
  document.querySelector(".reserve").addEventListener("click", async () => {
    const selected = [...document.querySelectorAll('.seat[data-status="selected"]')]
      .map(s => s.textContent);

    if (selected.length === 0) {
      alert("Please select at least one seat before reserving.");
      return;
    }

    const email = localStorage.getItem("loggedEmail") || "unknown@my.jcu.edu.au";

    try {
      // Reload current reservations to avoid race conditions
      const snapshot = await db
        .collection("reservations")
        .where("building", "==", buildingName)
        .where("room", "==", "Room 101")
        .get();

      const alreadyReserved = new Set();
      snapshot.forEach(doc => {
        const data = doc.data();
        let seatList = [];
        if (Array.isArray(data.seats)) {
          seatList = data.seats;
        } else if (typeof data.seat === "string") {
          seatList = data.seat.split(",").map(s => s.trim());
        }
        seatList.forEach(s => alreadyReserved.add(s));
      });

      // Check if any of the selected seats are already reserved
      const conflicts = selected.filter(s => alreadyReserved.has(s));

      if (conflicts.length > 0) {
        alert("Reservation failed. These seats are already taken: " + conflicts.join(", "));
        await loadReservedSeats();   // Refresh UI
        return;
      }

      // Save new reservation to Firestore
      await db.collection("reservations").add({
        email: email,
        seats: selected,                    // array of seat IDs
        seat: selected.join(", "),          // human-readable string
        building: buildingName,
        room: "Room 101",
        time: new Date().toLocaleString(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // ‚≠ê Save to localStorage for reservation_status.html
      localStorage.setItem("latestReservation", JSON.stringify({
        building: buildingName,
        room: "Room 101",
        seats: selected,
        time: new Date().toLocaleString()
      }));


      alert("Reservation successful!");
      window.location = "reservation_status.html";

    } catch (error) {
      console.error("Error while reserving seats:", error);
      alert("Failed to save reservation. Please try again.");
    }
  });
</script>
</body>
</html>
