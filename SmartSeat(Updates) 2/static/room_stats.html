<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Room Stats - SmartSeat</title>

  <style>
    :root { --pad: 16px; --radius: 14px; --fg:#111; --muted:#6b7280; }
    body {
      margin: 0; color: var(--fg); background: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    }

    header { display:flex; align-items:center; gap:10px; padding: var(--pad); }
    header .back {
      width:28px; height:28px; border-radius:50%; border:1px solid #ddd;
      display:grid; place-items:center; cursor:pointer;
    }

    h1 { font-size:22px; margin-left:6px; }

    /* legend */
    .legend { font-size:12px; color:var(--muted); display:flex; gap:14px; margin:6px var(--pad); }
    .legend span { display:flex; align-items:center; gap:6px; }
    .dot { width:10px; height:10px; border-radius:2px; }
    .green { background:#22c55e; }
    .yellow { background:#f59e0b; }
    .gray { background:#e5e7eb; }

    main { padding: var(--pad); display:flex; flex-direction:column; gap:18px; }

    .card {
      border:1px solid #eee; border-radius:var(--radius); padding:var(--pad);
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    .row { display:flex; gap:16px; }
    .grow { flex:1; padding-left:18px; }

    .kpi { display:flex; gap:16px; margin-bottom:8px; color:var(--muted); }
    .kpi strong { color:#111; font-size:18px; margin-right:4px; }

    #donut { max-width:360px; aspect-ratio:1/1; }
    #line { max-width:360px; height:180px; }

    /* Modal */
    #modalOverlay {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.85); justify-content:center; align-items:center;
      z-index:9999;
    }
    #modalContent { max-width:90%; max-height:90%; }
    #modalContent canvas { width:100%; }

    /* Night mode */
    body.night-mode { background:#222; color:#eee; }
    body.night-mode .legend span,
    body.night-mode h1 { color:#ccc; }
    body.night-mode .card {
      background:#333; border-color:#444;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.4);
    }
  </style>
</head>

<body>
  <header>
    <div class="back" onclick="history.back()">‚Üê</div>
    <h1 id="roomTitle">Room Stats</h1>
    <button id="toggleTheme" style="margin-left:10px;">Night</button>
  </header>

  <!-- legend -->
  <div class="legend">
    <span><i class="dot gray"></i> empty(<span id="emptyCountLegend">0</span>)</span>
    <span><i class="dot green"></i> on-time(<span id="onTimeCountLegend">0</span>)</span>
    <span><i class="dot yellow"></i> late(<span id="lateCountLegend">0</span>)</span>
  </div>

  <main>
    <section class="card">
      <div class="row">
        <canvas id="donut" width="360" height="360"></canvas>

        <div class="grow">
          <div class="label">Attendance</div>

          <div class="kpi">
            <div><strong id="occupancyPct">--%</strong> Occupancy</div>
            <div><strong id="absencePct">--%</strong> Absence</div>
          </div>

          <div class="kpi">
            <div><strong id="onTimeCount">0</strong> On-time</div>
            <div><strong id="lateCount">0</strong> Late</div>
            <div><strong id="emptyCount">0</strong> Empty</div>
          </div>

          <div class="kpi">
            <div><strong id="totalCount">0</strong> Total</div>
          </div>

          <button id="refreshButton">Refresh</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="label">Occupancy Trend Simulation</div>
      <canvas id="line" width="360" height="180"></canvas>
    </section>
  </main>

  <!-- modal for full screen chart -->
  <div id="modalOverlay" onclick="hideModal()">
    <div id="modalContent">
      <canvas id="enlargedCanvas"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /* Get room from URL */
    function getRoomFromQuery() {
      const p = new URLSearchParams(location.search);
      return p.get("room") || "Room 101";
    }

    document.getElementById("roomTitle").innerText = getRoomFromQuery();

    /* Mock Data */
    function getMockData() {
      return {
        counts: {
          empty: Math.floor(Math.random()*10),
          on_time: Math.floor(Math.random()*10),
          late: Math.floor(Math.random()*10),
        }
      };
    }

    function updateRoomData() {
      const data = getMockData();

      const empty = data.counts.empty;
      const onTime = data.counts.on_time;
      const late = data.counts.late;

      const total = empty + onTime + late;

      document.getElementById("emptyCount").textContent = empty;
      document.getElementById("onTimeCount").textContent = onTime;
      document.getElementById("lateCount").textContent = late;
      document.getElementById("totalCount").textContent = total;

      document.getElementById("emptyCountLegend").textContent = empty;
      document.getElementById("onTimeCountLegend").textContent = onTime;
      document.getElementById("lateCountLegend").textContent = late;

      const occupancy = total === 0 ? 0 : (onTime / total * 100);
      const absence = total === 0 ? 0 : (empty / total * 100);

      document.getElementById("occupancyPct").textContent = occupancy.toFixed(1) + "%";
      document.getElementById("absencePct").textContent = absence.toFixed(1) + "%";

      drawDonutChart([empty, onTime, late]);
      drawLineChart();
    }

    let donutChart = null;
    function drawDonutChart(values) {
      if (donutChart) donutChart.destroy();

      donutChart = new Chart(document.getElementById("donut"), {
        type: "doughnut",
        data: {
          labels: ["Empty", "On-time", "Late"],
          datasets: [{
            data: values,
            backgroundColor: ["#e5e7eb", "#22c55e", "#f59e0b"]
          }]
        },
        options: { plugins: { legend: { display: false } } }
      });
    }

    let lineChart = null;
    function drawLineChart() {
      const ctx = document.getElementById("line");

      if (lineChart) lineChart.destroy();

      lineChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: ["Mon","Tue","Wed","Thu","Fri"],
          datasets: [{
            data: [0.7,0.78,0.6,0.9,0.75],
            borderColor: "#2563eb",
            fill: false
          }]
        },
        options: { scales: { y: { beginAtZero: true } } }
      });
    }

    /* Modal enlarge chart */
    function showEnlarged(chartType) {
      const canvas = document.getElementById(chartType);
      const enlarged = document.getElementById("enlargedCanvas");
      const ctx = enlarged.getContext("2d");

      enlarged.width = canvas.width;
      enlarged.height = canvas.height;

      ctx.drawImage(canvas, 0, 0);

      document.getElementById("modalOverlay").style.display = "flex";
    }

    document.getElementById("donut").onclick = () => showEnlarged("donut");
    document.getElementById("line").onclick = () => showEnlarged("line");

    function hideModal() {
      document.getElementById("modalOverlay").style.display = "none";
    }

    /* Night mode */
    document.getElementById("toggleTheme").onclick = () =>
      document.body.classList.toggle("night-mode");

    document.getElementById("refreshButton").onclick = updateRoomData;

    updateRoomData();
  </script>

</body>
</html>
